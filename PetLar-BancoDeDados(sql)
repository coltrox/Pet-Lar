-- CRIAÇÃO DO BANCO
CREATE DATABASE IF NOT EXISTS PetLar;
USE PetLar;

-- TABELAS
CREATE TABLE Endereco (
    id_endereco INT AUTO_INCREMENT PRIMARY KEY,
    rua VARCHAR(100) NOT NULL,
    numero VARCHAR(10) NOT NULL,
    complemento VARCHAR(50),
    bairro VARCHAR(50) NOT NULL,
    cidade VARCHAR(50) NOT NULL,
    estado CHAR(2) NOT NULL
);

CREATE TABLE Usuario (
    id_usuario INT AUTO_INCREMENT PRIMARY KEY,
    nome_completo VARCHAR(100) NOT NULL,
    cpf CHAR(11) NOT NULL UNIQUE,
    data_nascimento DATE NOT NULL,
    email VARCHAR(100) NOT NULL UNIQUE,
    id_endereco INT NOT NULL,
    FOREIGN KEY (id_endereco) REFERENCES Endereco(id_endereco)
);

CREATE TABLE Formulario (
    id_formulario INT AUTO_INCREMENT PRIMARY KEY,
    respostas TEXT NOT NULL
);

CREATE TABLE Usuario_Formulario (
    id_usuario INT NOT NULL,
    id_formulario INT NOT NULL,
    PRIMARY KEY(id_usuario, id_formulario),
    FOREIGN KEY(id_usuario) REFERENCES Usuario(id_usuario),
    FOREIGN KEY(id_formulario) REFERENCES Formulario(id_formulario)
);

CREATE TABLE ONG (
    id_ong INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(100) NOT NULL,
    id_endereco INT NOT NULL,
    FOREIGN KEY(id_endereco) REFERENCES Endereco(id_endereco)
);

CREATE TABLE Pet (
    id_pet INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(50) NOT NULL,
    especie VARCHAR(30) NOT NULL,
    raca VARCHAR(50),
    data_nascimento DATE NOT NULL,
    sexo ENUM('Macho', 'Fêmea') NOT NULL,
    origem ENUM('Resgatado', 'Nascido na ONG', 'Doado') NOT NULL,
    id_ong INT NOT NULL,
    FOREIGN KEY(id_ong) REFERENCES ONG(id_ong)
);

CREATE TABLE Carteira_Vacinacao (
    id_carteira INT AUTO_INCREMENT PRIMARY KEY,
    id_pet INT UNIQUE NOT NULL,
    FOREIGN KEY(id_pet) REFERENCES Pet(id_pet)
);

CREATE TABLE Vacina (
    id_vacina INT AUTO_INCREMENT PRIMARY KEY,
    id_carteira INT NOT NULL,
    nome_vacina VARCHAR(100) NOT NULL,
    data_aplicacao DATE NOT NULL,
    FOREIGN KEY(id_carteira) REFERENCES Carteira_Vacinacao(id_carteira)
);

CREATE TABLE Solicitacao_Adocao (
    id_solicitacao INT AUTO_INCREMENT PRIMARY KEY,
    id_usuario INT NOT NULL,
    id_pet INT NOT NULL,
    id_ong INT NOT NULL,
    data_solicitacao DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    status ENUM('Pendente', 'Aprovado', 'Recusado') DEFAULT 'Pendente',
    observacao TEXT,
    FOREIGN KEY(id_usuario) REFERENCES Usuario(id_usuario),
    FOREIGN KEY(id_pet) REFERENCES Pet(id_pet),
    FOREIGN KEY(id_ong) REFERENCES ONG(id_ong)
);

CREATE TABLE Adocao (
    id_adocao INT AUTO_INCREMENT PRIMARY KEY,
    id_solicitacao INT NOT NULL UNIQUE,
    data_adocao DATE NOT NULL,
    FOREIGN KEY(id_solicitacao) REFERENCES Solicitacao_Adocao(id_solicitacao)
);

-- TRIGGER
DELIMITER //
CREATE TRIGGER trg_criar_adocao
AFTER UPDATE ON Solicitacao_Adocao
FOR EACH ROW
BEGIN
    IF NEW.status = 'Aprovado' AND OLD.status <> 'Aprovado' THEN
        INSERT INTO Adocao (id_solicitacao, data_adocao)
        VALUES (NEW.id_solicitacao, CURDATE());
    END IF;
END //
DELIMITER ;

-- PROCEDURES
DELIMITER //

CREATE PROCEDURE pr_inserir_ong(
    IN p_nome VARCHAR(100),
    IN p_id_endereco INT
)
BEGIN
    INSERT INTO ONG (nome, id_endereco)
    VALUES (p_nome, p_id_endereco);
END //

CREATE PROCEDURE pr_inserir_pet(
    IN p_nome VARCHAR(50),
    IN p_especie VARCHAR(30),
    IN p_raca VARCHAR(50),
    IN p_nasc DATE,
    IN p_sexo ENUM('Macho','Fêmea'),
    IN p_origem ENUM('Resgatado','Nascido na ONG','Doado'),
    IN p_id_ong INT
)
BEGIN
    INSERT INTO Pet (nome, especie, raca, data_nascimento, sexo, origem, id_ong)
    VALUES (p_nome, p_especie, p_raca, p_nasc, p_sexo, p_origem, p_id_ong);
END //

CREATE PROCEDURE pr_novo_usuario(
    IN p_nome VARCHAR(100),
    IN p_cpf CHAR(11),
    IN p_data_nasc DATE,
    IN p_email VARCHAR(100),
    IN p_id_endereco INT
)
BEGIN
    INSERT INTO Usuario (nome_completo, cpf, data_nascimento, email, id_endereco)
    VALUES (p_nome, p_cpf, p_data_nasc, p_email, p_id_endereco);
END //

CREATE PROCEDURE pr_nova_vacina(
    IN p_id_carteira INT,
    IN p_nome VARCHAR(100),
    IN p_data DATE
)
BEGIN
    INSERT INTO Vacina (id_carteira, nome_vacina, data_aplicacao)
    VALUES (p_id_carteira, p_nome, p_data);
END //

CREATE PROCEDURE pr_listar_pets_ong(IN p_ong INT)
BEGIN
    SELECT *
    FROM Pet
    WHERE id_ong = p_ong;
END //

CREATE PROCEDURE pr_vacinas_pet(IN p_id_pet INT)
BEGIN
    SELECT v.nome_vacina, v.data_aplicacao
    FROM Vacina v
    JOIN Carteira_Vacinacao c ON v.id_carteira = c.id_carteira
    WHERE c.id_pet = p_id_pet;
END //

CREATE PROCEDURE pr_criar_solicitacao(
    IN p_usuario INT,
    IN p_pet INT,
    IN p_ong INT,
    IN p_obs TEXT
)
BEGIN
    INSERT INTO Solicitacao_Adocao(id_usuario, id_pet, id_ong, observacao)
    VALUES (p_usuario, p_pet, p_ong, p_obs);
END //

CREATE PROCEDURE pr_set_status(
    IN p_id INT,
    IN p_status ENUM('Pendente','Aprovado','Recusado')
)
BEGIN
    UPDATE Solicitacao_Adocao
    SET status = p_status
    WHERE id_solicitacao = p_id;
END //

CREATE PROCEDURE pr_total_pendentes(OUT p_total INT)
BEGIN
    SELECT COUNT(*) INTO p_total
    FROM Solicitacao_Adocao
    WHERE status = 'Pendente';
END //

CREATE PROCEDURE pr_total_adocoes(OUT p_total INT)
BEGIN
    SELECT COUNT(*) INTO p_total
    FROM Adocao;
END //

CREATE PROCEDURE pr_usuario_cpf(IN p_cpf CHAR(11))
BEGIN
    SELECT * FROM Usuario WHERE cpf = p_cpf;
END //

CREATE PROCEDURE pr_pets_disponiveis()
BEGIN
    SELECT *
    FROM Pet
    WHERE id_pet NOT IN (
        SELECT id_pet
        FROM Solicitacao_Adocao
        WHERE status = 'Aprovado'
    );
END //

CREATE PROCEDURE pr_historico_usuario(IN p_id_usuario INT)
BEGIN
    SELECT a.id_adocao, p.nome AS pet, a.data_adocao, o.nome AS ong
    FROM Adocao a
    JOIN Solicitacao_Adocao s ON a.id_solicitacao = s.id_solicitacao
    JOIN Pet p ON s.id_pet = p.id_pet
    JOIN ONG o ON s.id_ong = o.id_ong
    WHERE s.id_usuario = p_id_usuario;
END //

CREATE PROCEDURE pr_deletar_solicitacao(IN p_id INT)
BEGIN
    DELETE FROM Solicitacao_Adocao
    WHERE id_solicitacao = p_id;
END //

CREATE PROCEDURE pr_editar_pet(
    IN p_id INT,
    IN p_nome VARCHAR(50),
    IN p_raca VARCHAR(50),
    IN p_origem ENUM('Resgatado','Nascido na ONG','Doado')
)
BEGIN
    UPDATE Pet
    SET nome = p_nome,
        raca = p_raca,
        origem = p_origem
    WHERE id_pet = p_id;
END //

DELIMITER ;
